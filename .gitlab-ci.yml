default:
  image: 
    name: node:16.20.1-alpine3.18
    pull_policy: if-not-present
  tags:
    - yc-builder

stages:
  - prepare
  - push
  - publish

# PREPARE (install, build, inc version, check version in npm)  

Prepare:
  stage: prepare
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^v\d+\.\d+\.\d+.*/
      when: never
    - changes:
      - .gitlab-ci.yml
      - packages/oidc-pkce-public-client/*
  script:
    - |
      yarn install
      yarn run build

      # Add version 0.0.x
      yarn workspace @i-novus/oidc-pkce-public-client version patch

      NPM_PACKAGE_NAME=$(node -p "require('./packages/oidc-pkce-public-client/package.json').name")
      NPM_PACKAGE_VERSION=$(node -p "require('./packages/oidc-pkce-public-client/package.json').version")
      
      if [[ "$(npm view ${NPM_PACKAGE_NAME} versions)" == *"'${NPM_PACKAGE_VERSION}'"* ]]; then
        echo "Version ${NPM_PACKAGE_VERSION} of ${NPM_PACKAGE_NAME} has already been published"
        exit 1
      fi

# PUSH (git push commit with version and tag)

Push:
  stage: push
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^v\d+\.\d+\.\d+.*/
      when: never
    - changes:
      - .gitlab-ci.yml
      - packages/oidc-pkce-public-client/*
  before_script:
    - |
      git config --global user.name "${GITLAB_USER_NAME}"
      git config --global user.email "${GITLAB_USER_NAME}@i-novus.ru"
  script:
    - |
      #       GITLAB_HOST_WITH_AUTH="http://${GITLAB_USER_NAME}:${GITLAB_USER_TOKEN}@${GITLAB_PROJECT}"
            
      #       git add .
      #       git commit -m "v${NPM_PACKAGE_VERSION}"
      #       git push $GITLAB_HOST_WITH_AUTH HEAD:$CI_COMMIT_BRANCH
      #       git tag v${NPM_PACKAGE_VERSION} $CI_COMMIT_BRANCH
      #       git push v${NPM_PACKAGE_VERSION} $GITLAB_HOST_WITH_AUTH HEAD:$CI_COMMIT_BRANCH

      echo "Successfully pushed ${NPM_PACKAGE_NAME}@${NPM_PACKAGE_VERSION} to git!"

# PUBLISH (publish package to npm registry)

Publish:
  stage: publish
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^v\d+\.\d+\.\d+.*/
      when: never
    - changes:
      - .gitlab-ci.yml
      - packages/oidc-pkce-public-client/*
  script:
    - |
      # cross-env YARN_NPM_AUTH_TOKEN=${NPM_PUBLISH_TOKEN} YARN_NPM_ALWAYS_AUTH=true yarn workspace @i-novus/oidc-pkce-public-client npm publish --access public

      echo "Successfully published ${NPM_PACKAGE_NAME}@${NPM_PACKAGE_VERSION} to NPM registry!"
