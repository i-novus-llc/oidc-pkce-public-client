publish:
  image: node:latest
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^v\d+\.\d+\.\d+.*/
      when: never
    - changes:
      - .gitlab-ci.yml
      - packages/oidc-pkce-public-client/*
  script:
    - yarn install
    - yarn run build

    # Add version 0.0.x
    - yarn workspace @i-novus/oidc-pkce-public-client version patch

    - NPM_PACKAGE_NAME=$(node -p "require('./packages/oidc-pkce-public-client/package.json').name")
    - NPM_PACKAGE_VERSION=$(node -p "require('./packages/oidc-pkce-public-client/package.json').version")

    - |
      if [[ "$(npm view ${NPM_PACKAGE_NAME} versions)" == *"'${NPM_PACKAGE_VERSION}'"* ]]; then
        echo "Version ${NPM_PACKAGE_VERSION} of ${NPM_PACKAGE_NAME} has already been published"
        exit 1
      fi

    - echo "Start publish ${NPM_PACKAGE_NAME}@${NPM_PACKAGE_VERSION}"

    - git config --global user.email "ci@i-novus.ru"
    - git config --global user.name "CI"

    - git add .
    - git commit -m "v${NPM_PACKAGE_VERSION}"
    - git push
    - git tag v${NPM_PACKAGE_VERSION} $CI_COMMIT_BRANCH
    - git push origin v${NPM_PACKAGE_VERSION}

    - cross-env YARN_NPM_AUTH_TOKEN=${NPM_PUBLISH_TOKEN} YARN_NPM_ALWAYS_AUTH=true yarn workspace @i-novus/oidc-pkce-public-client npm publish --access public

    - echo "Successfully published ${NPM_PACKAGE_NAME}@${NPM_PACKAGE_VERSION} to NPM registry!"

